import { useMemo } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useVulnerability } from '../context/VulnerabilityContext';
import {
  ArrowLeft,
  ExternalLink,
  Package,
  Calendar,
  Shield,
  AlertTriangle,
  CheckCircle,
  XCircle,
  GitCompare,
} from 'lucide-react';
import {
  Box,
  Button,
  Card,
  Chip,
  Typography,
  Paper,
} from '@mui/material';
import { getSeverityColor } from '../theme';

function VulnerabilityDetail() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const { allVulnerabilities, selectedForComparison, toggleComparison } =
    useVulnerability();

  const vulnerability = useMemo(
    () => allVulnerabilities.find((v) => v.id === id),
    [allVulnerabilities, id]
  );

  if (!vulnerability) {
    return (
      <Box sx={{ width: '100%' }}>
        <Box
          sx={{
            display: 'flex',
            flexDirection: 'column',
            alignItems: 'center',
            justifyContent: 'center',
            gap: 3,
            minHeight: '60vh',
            color: 'text.secondary',
          }}
        >
          <AlertTriangle size={48} />
          <Typography variant="h4" color="text.primary">
            Vulnerability Not Found
          </Typography>
          <Button
            variant="contained"
            startIcon={<ArrowLeft size={18} />}
            onClick={() => navigate('/vulnerabilities')}
          >
            Back to List
          </Button>
        </Box>
      </Box>
    );
  }

  const isSelected = selectedForComparison.has(vulnerability.id);
  const hasFix = vulnerability.status.toLowerCase().includes('fixed');

  return (
    <Box sx={{ width: '100%' }}>
      <Box
        sx={{
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center',
          mb: 4,
          gap: 3,
          flexDirection: { xs: 'column', md: 'row' },
        }}
      >
        <Button
          variant="text"
          startIcon={<ArrowLeft size={18} />}
          onClick={() => navigate(-1)}
          sx={{ color: 'text.secondary' }}
        >
          Back
        </Button>

        <Box
          sx={{
            display: 'flex',
            gap: 1,
            width: { xs: '100%', md: 'auto' },
            flexDirection: { xs: 'column', sm: 'row' },
          }}
        >
          <Button
            variant={isSelected ? 'contained' : 'outlined'}
            startIcon={<GitCompare size={18} />}
            onClick={() => toggleComparison(vulnerability.id)}
            fullWidth={false}
          >
            {isSelected ? 'Remove from Comparison' : 'Add to Comparison'}
          </Button>

          {vulnerability.link && (
            <Button
              variant="outlined"
              startIcon={<ExternalLink size={18} />}
              href={vulnerability.link}
              target="_blank"
              rel="noopener noreferrer"
              component="a"
              fullWidth={false}
            >
              View on NVD
            </Button>
          )}
        </Box>
      </Box>

      <Box
        sx={{
          display: 'grid',
          gridTemplateColumns: { xs: '1fr', lg: '1fr 350px' },
          gap: 4,
        }}
      >
        <Box sx={{ display: 'flex', flexDirection: 'column', gap: 3 }}>
          <Card sx={{ p: 4 }}>
            <Box
              sx={{
                mb: 4,
                pb: 4,
                borderBottom: 1,
                borderColor: 'divider',
              }}
            >
              <Box
                sx={{
                  display: 'flex',
                  gap: 3,
                  mb: 2,
                  flexDirection: { xs: 'column', sm: 'row' },
                  alignItems: { xs: 'flex-start', sm: 'center' },
                }}
              >
                <Typography
                  variant="h3"
                  sx={{
                    fontSize: '2rem',
                    fontWeight: 700,
                    fontFamily: '"Monaco", "Courier New", monospace',
                  }}
                >
                  {vulnerability.cve}
                </Typography>
                <Chip
                  label={vulnerability.severity}
                  sx={{
                    bgcolor: getSeverityColor(vulnerability.severity),
                    color: '#fff',
                  }}
                />
              </Box>
              {vulnerability.kaiStatus && (
                <Box
                  sx={{
                    display: 'inline-flex',
                    alignItems: 'center',
                    gap: 1,
                    px: 2,
                    py: 1,
                    bgcolor: 'rgba(6, 182, 212, 0.1)',
                    border: '1px solid',
                    borderColor: 'secondary.main',
                    borderRadius: 1.5,
                    fontSize: '0.875rem',
                    color: 'text.secondary',
                  }}
                >
                  Analysis Status:{' '}
                  <Typography
                    component="code"
                    sx={{
                      color: 'secondary.main',
                      fontWeight: 600,
                    }}
                  >
                    {vulnerability.kaiStatus}
                  </Typography>
                </Box>
              )}
            </Box>

            <Box sx={{ mb: 4 }}>
              <Paper
                sx={{
                  display: 'flex',
                  flexDirection: 'column',
                  alignItems: 'center',
                  p: 4,
                  background:
                    'linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(6, 182, 212, 0.1))',
                  border: '2px solid',
                  borderColor: 'primary.main',
                  borderRadius: 3,
                }}
              >
                <Typography
                  sx={{
                    fontSize: '0.875rem',
                    color: 'text.secondary',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em',
                    mb: 1,
                  }}
                >
                  CVSS Score
                </Typography>
                <Typography
                  sx={{
                    fontSize: '4rem',
                    fontWeight: 700,
                    color: 'primary.main',
                    lineHeight: 1,
                    mb: 1,
                    fontFeatureSettings: '"tnum"',
                  }}
                >
                  {vulnerability.cvss}
                </Typography>
                <Typography
                  sx={{
                    fontSize: '1.125rem',
                    fontWeight: 600,
                    color: 'text.primary',
                  }}
                >
                  {vulnerability.severity.toUpperCase()}
                </Typography>
              </Paper>
            </Box>

            <Box sx={{ mb: 4 }}>
              <Typography variant="h5" sx={{ mb: 2, fontWeight: 600 }}>
                Description
              </Typography>
              <Typography
                sx={{
                  color: 'text.secondary',
                  lineHeight: 1.7,
                  fontSize: '0.9375rem',
                }}
              >
                {vulnerability.description}
              </Typography>
            </Box>

            {vulnerability.riskFactors && Object.keys(vulnerability.riskFactors).length > 0 && (
              <Box sx={{ mb: 4 }}>
                <Typography variant="h5" sx={{ mb: 2, fontWeight: 600 }}>
                  Risk Factors
                </Typography>
                <Box
                  sx={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(auto-fill, minmax(200px, 1fr))',
                    gap: 1,
                  }}
                >
                  {Object.keys(vulnerability.riskFactors).map((factor) => (
                    <Chip
                      key={factor}
                      icon={<AlertTriangle size={16} />}
                      label={factor}
                      sx={{
                        bgcolor: '#252b3b',
                        border: '1px solid',
                        borderColor: 'divider',
                        color: 'text.primary',
                        '& .MuiChip-icon': {
                          color: 'warning.main',
                        },
                      }}
                    />
                  ))}
                </Box>
              </Box>
            )}

            <Box sx={{ mb: 4 }}>
              <Typography variant="h5" sx={{ mb: 2, fontWeight: 600 }}>
                Fix Status
              </Typography>
              <Paper
                sx={{
                  display: 'flex',
                  alignItems: 'center',
                  gap: 3,
                  p: 3,
                  bgcolor: '#252b3b',
                  border: '1px solid',
                  borderColor: 'divider',
                }}
              >
                <Box sx={{ flexShrink: 0 }}>
                  {hasFix ? (
                    <CheckCircle size={32} color="#10b981" />
                  ) : (
                    <XCircle size={32} color="#dc2626" />
                  )}
                </Box>
                <Box sx={{ flex: 1 }}>
                  <Typography
                    sx={{
                      fontSize: '0.875rem',
                      color: 'text.secondary',
                      mb: 0.5,
                      textTransform: 'uppercase',
                      letterSpacing: '0.05em',
                    }}
                  >
                    {hasFix ? 'Fix Available' : 'No Fix Available'}
                  </Typography>
                  <Typography
                    sx={{
                      fontSize: '1.125rem',
                      fontWeight: 600,
                      color: 'text.primary',
                    }}
                  >
                    {vulnerability.status}
                  </Typography>
                </Box>
              </Paper>
            </Box>

            {vulnerability.applicableRules && vulnerability.applicableRules.length > 0 && (
              <Box sx={{ mb: 4 }}>
                <Typography variant="h5" sx={{ mb: 2, fontWeight: 600 }}>
                  Applicable Rules
                </Typography>
                <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1 }}>
                  {vulnerability.applicableRules.map((rule, index) => (
                    <Paper
                      key={index}
                      component="code"
                      sx={{
                        p: 2,
                        bgcolor: '#252b3b',
                        border: '1px solid',
                        borderColor: 'divider',
                        color: 'secondary.main',
                        fontFamily: '"Monaco", "Courier New", monospace',
                        fontSize: '0.875rem',
                      }}
                    >
                      {rule}
                    </Paper>
                  ))}
                </Box>
              </Box>
            )}
          </Card>
        </Box>

        <Box
          sx={{
            display: 'flex',
            flexDirection: 'column',
            gap: 3,
            order: { xs: 2, lg: 0 },
          }}
        >
          <Card sx={{ p: 3 }}>
            <Box
              sx={{
                display: 'flex',
                alignItems: 'center',
                gap: 1,
                mb: 3,
                pb: 2,
                borderBottom: 1,
                borderColor: 'divider',
              }}
            >
              <Package size={20} color="#8b5cf6" />
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                Package Information
              </Typography>
            </Box>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 0.5 }}>
                <Typography
                  sx={{
                    fontSize: '0.75rem',
                    color: 'text.disabled',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em',
                    fontWeight: 600,
                  }}
                >
                  Name
                </Typography>
                <Typography
                  sx={{
                    fontSize: '0.9375rem',
                    color: 'text.primary',
                    wordBreak: 'break-word',
                  }}
                >
                  {vulnerability.packageName}
                </Typography>
              </Box>
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 0.5 }}>
                <Typography
                  sx={{
                    fontSize: '0.75rem',
                    color: 'text.disabled',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em',
                    fontWeight: 600,
                  }}
                >
                  Version
                </Typography>
                <Typography
                  sx={{
                    fontSize: '0.9375rem',
                    color: 'text.primary',
                    wordBreak: 'break-word',
                  }}
                >
                  {vulnerability.packageVersion}
                </Typography>
              </Box>
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 0.5 }}>
                <Typography
                  sx={{
                    fontSize: '0.75rem',
                    color: 'text.disabled',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em',
                    fontWeight: 600,
                  }}
                >
                  Type
                </Typography>
                <Typography
                  sx={{
                    fontSize: '0.9375rem',
                    color: 'text.primary',
                    wordBreak: 'break-word',
                  }}
                >
                  {vulnerability.packageType}
                </Typography>
              </Box>
            </Box>
          </Card>

          <Card sx={{ p: 3 }}>
            <Box
              sx={{
                display: 'flex',
                alignItems: 'center',
                gap: 1,
                mb: 3,
                pb: 2,
                borderBottom: 1,
                borderColor: 'divider',
              }}
            >
              <Calendar size={20} color="#8b5cf6" />
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                Timeline
              </Typography>
            </Box>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 0.5 }}>
                <Typography
                  sx={{
                    fontSize: '0.75rem',
                    color: 'text.disabled',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em',
                    fontWeight: 600,
                  }}
                >
                  Published
                </Typography>
                <Typography
                  sx={{
                    fontSize: '0.9375rem',
                    color: 'text.primary',
                    wordBreak: 'break-word',
                  }}
                >
                  {new Date(vulnerability.published).toLocaleDateString()}
                </Typography>
              </Box>
              {vulnerability.fixDate && (
                <Box sx={{ display: 'flex', flexDirection: 'column', gap: 0.5 }}>
                  <Typography
                    sx={{
                      fontSize: '0.75rem',
                      color: 'text.disabled',
                      textTransform: 'uppercase',
                      letterSpacing: '0.05em',
                      fontWeight: 600,
                    }}
                  >
                    Fix Date
                  </Typography>
                  <Typography
                    sx={{
                      fontSize: '0.9375rem',
                      color: 'text.primary',
                      wordBreak: 'break-word',
                    }}
                  >
                    {new Date(vulnerability.fixDate).toLocaleDateString()}
                  </Typography>
                </Box>
              )}
              {vulnerability.layerTime && vulnerability.layerTime !== '1970-01-01 00:00:00' && (
                <Box sx={{ display: 'flex', flexDirection: 'column', gap: 0.5 }}>
                  <Typography
                    sx={{
                      fontSize: '0.75rem',
                      color: 'text.disabled',
                      textTransform: 'uppercase',
                      letterSpacing: '0.05em',
                      fontWeight: 600,
                    }}
                  >
                    Layer Time
                  </Typography>
                  <Typography
                    sx={{
                      fontSize: '0.9375rem',
                      color: 'text.primary',
                      wordBreak: 'break-word',
                    }}
                  >
                    {new Date(vulnerability.layerTime).toLocaleDateString()}
                  </Typography>
                </Box>
              )}
            </Box>
          </Card>

          <Card sx={{ p: 3 }}>
            <Box
              sx={{
                display: 'flex',
                alignItems: 'center',
                gap: 1,
                mb: 3,
                pb: 2,
                borderBottom: 1,
                borderColor: 'divider',
              }}
            >
              <Shield size={20} color="#8b5cf6" />
              <Typography variant="h6" sx={{ fontWeight: 600 }}>
                Context
              </Typography>
            </Box>
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 0.5 }}>
                <Typography
                  sx={{
                    fontSize: '0.75rem',
                    color: 'text.disabled',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em',
                    fontWeight: 600,
                  }}
                >
                  Group
                </Typography>
                <Typography
                  sx={{
                    fontSize: '0.9375rem',
                    color: 'text.primary',
                    wordBreak: 'break-word',
                  }}
                >
                  {vulnerability.groupName}
                </Typography>
              </Box>
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 0.5 }}>
                <Typography
                  sx={{
                    fontSize: '0.75rem',
                    color: 'text.disabled',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em',
                    fontWeight: 600,
                  }}
                >
                  Repository
                </Typography>
                <Typography
                  sx={{
                    fontSize: '0.9375rem',
                    color: 'text.primary',
                    wordBreak: 'break-word',
                  }}
                >
                  {vulnerability.repoName}
                </Typography>
              </Box>
              <Box sx={{ display: 'flex', flexDirection: 'column', gap: 0.5 }}>
                <Typography
                  sx={{
                    fontSize: '0.75rem',
                    color: 'text.disabled',
                    textTransform: 'uppercase',
                    letterSpacing: '0.05em',
                    fontWeight: 600,
                  }}
                >
                  Image Version
                </Typography>
                <Typography
                  sx={{
                    fontSize: '0.9375rem',
                    color: 'text.primary',
                    wordBreak: 'break-word',
                  }}
                >
                  {vulnerability.imageVersion}
                </Typography>
              </Box>
            </Box>
          </Card>
        </Box>
      </Box>
    </Box>
  );
}

export default VulnerabilityDetail;
