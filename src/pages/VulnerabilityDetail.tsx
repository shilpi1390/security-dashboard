import { useMemo } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { useVulnerability } from '../context/VulnerabilityContext';
import {
  ArrowLeft,
  ExternalLink,
  Package,
  Calendar,
  Shield,
  AlertTriangle,
  CheckCircle,
  XCircle,
  GitCompare,
} from 'lucide-react';
import './VulnerabilityDetail.css';

function VulnerabilityDetail() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const { allVulnerabilities, selectedForComparison, toggleComparison } =
    useVulnerability();

  const vulnerability = useMemo(
    () => allVulnerabilities.find((v) => v.id === id),
    [allVulnerabilities, id]
  );

  if (!vulnerability) {
    return (
      <div className="detail-page">
        <div className="error-message">
          <AlertTriangle size={48} />
          <h2>Vulnerability Not Found</h2>
          <button className="btn btn-primary" onClick={() => navigate('/vulnerabilities')}>
            <ArrowLeft size={18} />
            Back to List
          </button>
        </div>
      </div>
    );
  }

  const isSelected = selectedForComparison.has(vulnerability.id);
  const hasFix = vulnerability.status.toLowerCase().includes('fixed');

  return (
    <div className="detail-page">
      <div className="detail-header">
        <button className="btn btn-ghost" onClick={() => navigate(-1)}>
          <ArrowLeft size={18} />
          Back
        </button>

        <div className="header-actions">
          <button
            className={`btn ${isSelected ? 'btn-primary' : 'btn-secondary'}`}
            onClick={() => toggleComparison(vulnerability.id)}
          >
            <GitCompare size={18} />
            {isSelected ? 'Remove from Comparison' : 'Add to Comparison'}
          </button>

          {vulnerability.link && (
            <a
              href={vulnerability.link}
              target="_blank"
              rel="noopener noreferrer"
              className="btn btn-secondary"
            >
              <ExternalLink size={18} />
              View on NVD
            </a>
          )}
        </div>
      </div>

      <div className="detail-content">
        <div className="detail-main">
          <div className="detail-card">
            <div className="detail-title-section">
              <div className="title-row">
                <h1>{vulnerability.cve}</h1>
                <span className={`badge badge-${vulnerability.severity}`}>
                  {vulnerability.severity}
                </span>
              </div>
              {vulnerability.kaiStatus && (
                <div className="kai-status-badge">
                  Analysis Status: <code>{vulnerability.kaiStatus}</code>
                </div>
              )}
            </div>

            <div className="cvss-section">
              <div className="cvss-score-display">
                <div className="cvss-label">CVSS Score</div>
                <div className="cvss-value">{vulnerability.cvss}</div>
                <div className="cvss-severity">{vulnerability.severity.toUpperCase()}</div>
              </div>
            </div>

            <div className="description-section">
              <h2>Description</h2>
              <p>{vulnerability.description}</p>
            </div>

            {vulnerability.riskFactors && Object.keys(vulnerability.riskFactors).length > 0 && (
              <div className="risk-factors-section">
                <h2>Risk Factors</h2>
                <div className="risk-factors-grid">
                  {Object.keys(vulnerability.riskFactors).map((factor) => (
                    <div key={factor} className="risk-factor-chip">
                      <AlertTriangle size={16} />
                      {factor}
                    </div>
                  ))}
                </div>
              </div>
            )}

            <div className="status-section">
              <h2>Fix Status</h2>
              <div className="status-card">
                <div className="status-icon">
                  {hasFix ? (
                    <CheckCircle size={32} className="icon-success" />
                  ) : (
                    <XCircle size={32} className="icon-error" />
                  )}
                </div>
                <div className="status-content">
                  <div className="status-label">
                    {hasFix ? 'Fix Available' : 'No Fix Available'}
                  </div>
                  <div className="status-value">{vulnerability.status}</div>
                </div>
              </div>
            </div>

            {vulnerability.applicableRules && vulnerability.applicableRules.length > 0 && (
              <div className="rules-section">
                <h2>Applicable Rules</h2>
                <div className="rules-list">
                  {vulnerability.applicableRules.map((rule, index) => (
                    <code key={index} className="rule-item">
                      {rule}
                    </code>
                  ))}
                </div>
              </div>
            )}
          </div>
        </div>

        <div className="detail-sidebar">
          <div className="sidebar-card">
            <h3>
              <Package size={20} />
              Package Information
            </h3>
            <div className="info-list">
              <div className="info-item">
                <span className="info-label">Name</span>
                <span className="info-value">{vulnerability.packageName}</span>
              </div>
              <div className="info-item">
                <span className="info-label">Version</span>
                <span className="info-value">{vulnerability.packageVersion}</span>
              </div>
              <div className="info-item">
                <span className="info-label">Type</span>
                <span className="info-value">{vulnerability.packageType}</span>
              </div>
            </div>
          </div>

          <div className="sidebar-card">
            <h3>
              <Calendar size={20} />
              Timeline
            </h3>
            <div className="info-list">
              <div className="info-item">
                <span className="info-label">Published</span>
                <span className="info-value">
                  {new Date(vulnerability.published).toLocaleDateString()}
                </span>
              </div>
              {vulnerability.fixDate && (
                <div className="info-item">
                  <span className="info-label">Fix Date</span>
                  <span className="info-value">
                    {new Date(vulnerability.fixDate).toLocaleDateString()}
                  </span>
                </div>
              )}
              {vulnerability.layerTime && vulnerability.layerTime !== '1970-01-01 00:00:00' && (
                <div className="info-item">
                  <span className="info-label">Layer Time</span>
                  <span className="info-value">
                    {new Date(vulnerability.layerTime).toLocaleDateString()}
                  </span>
                </div>
              )}
            </div>
          </div>

          <div className="sidebar-card">
            <h3>
              <Shield size={20} />
              Context
            </h3>
            <div className="info-list">
              <div className="info-item">
                <span className="info-label">Group</span>
                <span className="info-value">{vulnerability.groupName}</span>
              </div>
              <div className="info-item">
                <span className="info-label">Repository</span>
                <span className="info-value">{vulnerability.repoName}</span>
              </div>
              <div className="info-item">
                <span className="info-label">Image Version</span>
                <span className="info-value">{vulnerability.imageVersion}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

export default VulnerabilityDetail;
