import { useState, useCallback, useRef, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { useVirtualizer } from "@tanstack/react-virtual";
import { useVulnerability } from "../context/VulnerabilityContext";
import {
  Box,
  Typography,
  TextField,
  Button,
  Chip,
  Checkbox,
  IconButton,
  Menu,
  MenuItem,
  InputAdornment,
} from "@mui/material";
import {
  Search,
  SlidersHorizontal,
  Download,
  ArrowUpDown,
  GitCompare,
  ExternalLink,
  Filter,
  X,
} from "lucide-react";
import AnalysisModeSelector from "../components/AnalysisModeSelector";
import FilterPanel from "../components/FilterPanel";
import LoadingSpinner from "../components/LoadingSpinner";
import { exportToJSON, exportToCSV } from "../utils/dataLoader";
import { getSeverityColor } from "../theme";

const defaultFilters = {
  severity: [],
  kaiStatus: [],
  packageType: [],
  riskFactors: [],
  searchQuery: "",
  status: [],
  dateRange: {
    start: null,
    end: null,
  },
};

function VulnerabilityList() {
  const navigate = useNavigate();
  const {
    filteredVulnerabilities,
    isLoading,
    filters,
    setFilters,
    setSorting,
    sortBy,
    sortOrder,
    selectedForComparison,
    toggleComparison,
  } = useVulnerability();

  const [showFilters, setShowFilters] = useState(false);
  const [searchQuery, setSearchQuery] = useState(filters.searchQuery);
  const [showExportMenu, setShowExportMenu] = useState(false);

  const parentRef = useRef<HTMLDivElement>(null);

  const virtualizer = useVirtualizer({
    count: filteredVulnerabilities.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 120,
    overscan: 10,
  });

  const handleSearch = useCallback(
    (value: string) => {
      setSearchQuery(value);
      setFilters({ ...filters, searchQuery: value });
    },
    [filters, setFilters],
  );

  const handleSort = (field: string) => {
    const newOrder = sortBy === field && sortOrder === "desc" ? "asc" : "desc";
    setSorting(field as any, newOrder);
  };

  const [exportAnchorEl, setExportAnchorEl] = useState<null | HTMLElement>(
    null,
  );

  const handleExport = (format: "json" | "csv") => {
    const timestamp = new Date().toISOString().split("T")[0];
    if (format === "json") {
      exportToJSON(
        filteredVulnerabilities,
        `vulnerabilities-${timestamp}.json`,
      );
    } else {
      exportToCSV(filteredVulnerabilities, `vulnerabilities-${timestamp}.csv`);
    }
    setExportAnchorEl(null);
    setShowExportMenu(false);
  };

  // Close export menu when clicking outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as HTMLElement;
      if (!target.closest(".dropdown")) {
        setShowExportMenu(false);
      }
    };

    if (showExportMenu) {
      document.addEventListener("mousedown", handleClickOutside);
    }

    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [showExportMenu]);

  const clearFilter = (filterType: keyof typeof filters) => {
    if (
      filterType === "severity" ||
      filterType === "packageType" ||
      filterType === "riskFactors" ||
      filterType === "status"
    ) {
      setFilters({ ...filters, [filterType]: [] });
    } else if (filterType === "dateRange") {
      setFilters({ ...filters, dateRange: { start: null, end: null } });
    }
  };

  const hasActiveFilters =
    filters.severity.length > 0 ||
    filters.packageType.length > 0 ||
    filters.riskFactors.length > 0 ||
    filters.status.length > 0 ||
    (filters.dateRange.start !== null && filters.dateRange.end !== null);

  if (isLoading) {
    return <LoadingSpinner />;
  }

  return (
    <Box sx={{ width: "100%" }}>
      {/* Page Header */}
      <Box
        sx={{
          display: "flex",
          justifyContent: "space-between",
          alignItems: "flex-start",
          mb: 3,
          gap: 2,
        }}
      >
        <Box>
          <Typography variant="h4" sx={{ fontWeight: 700, mb: 0.5 }}>
            Vulnerabilities
          </Typography>
          <Typography variant="body2" color="text.secondary">
            {filteredVulnerabilities.length.toLocaleString()} vulnerabilities
            found
          </Typography>
        </Box>
        <AnalysisModeSelector />
      </Box>

      {/* Toolbar */}
      <Box
        sx={{
          display: "flex",
          gap: 2,
          mb: 2,
          flexWrap: "wrap",
        }}
      >
        <TextField
          placeholder="Search CVE, package, description..."
          value={searchQuery}
          onChange={(e) => handleSearch(e.target.value)}
          InputProps={{
            startAdornment: (
              <InputAdornment position="start">
                <Search size={20} />
              </InputAdornment>
            ),
          }}
          sx={{
            flex: 1,
            minWidth: "300px",
          }}
        />

        <Box sx={{ display: "flex", gap: 1, alignItems: "center" }}>
          <Button
            variant={showFilters ? "contained" : "outlined"}
            startIcon={<SlidersHorizontal size={18} />}
            onClick={() => setShowFilters(!showFilters)}
          >
            Filters
          </Button>

          <Button
            variant="outlined"
            startIcon={<Download size={18} />}
            onClick={(e) => setExportAnchorEl(e.currentTarget)}
          >
            Export
          </Button>
          <Menu
            anchorEl={exportAnchorEl}
            open={Boolean(exportAnchorEl)}
            onClose={() => setExportAnchorEl(null)}
          >
            <MenuItem onClick={() => handleExport("json")}>
              Export as JSON
            </MenuItem>
            <MenuItem onClick={() => handleExport("csv")}>
              Export as CSV
            </MenuItem>
          </Menu>

          {selectedForComparison.size > 0 && (
            <Button
              variant="contained"
              startIcon={<GitCompare size={18} />}
              onClick={() => navigate("/comparison")}
            >
              Compare ({selectedForComparison.size})
            </Button>
          )}
        </Box>
      </Box>

      {showFilters && <FilterPanel />}

      {/* Active Filters Banner */}
      {hasActiveFilters && (
        <Box
          sx={{
            background:
              "linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(6, 182, 212, 0.1))",
            border: "1px solid",
            borderColor: "primary.main",
            borderRadius: 2,
            p: 2,
            mb: 2,
            animation: "slideDown 0.3s ease-out",
            "@keyframes slideDown": {
              from: {
                opacity: 0,
                transform: "translateY(-10px)",
              },
              to: {
                opacity: 1,
                transform: "translateY(0)",
              },
            },
          }}
        >
          <Box sx={{ display: "flex", alignItems: "flex-start", gap: 2 }}>
            <Filter size={18} style={{ marginTop: "2px", flexShrink: 0 }} />
            <Box
              sx={{
                display: "flex",
                flexWrap: "wrap",
                alignItems: "center",
                gap: 1,
                flex: 1,
              }}
            >
              <Typography
                variant="body2"
                sx={{ fontWeight: 600, fontSize: "0.875rem" }}
              >
                Active Filters:
              </Typography>
              {filters.severity.length > 0 && (
                <Chip
                  label={`Severity: ${filters.severity.join(", ")}`}
                  onDelete={() => clearFilter("severity")}
                  color="primary"
                  size="small"
                  deleteIcon={<X size={14} />}
                />
              )}
              {filters.packageType.length > 0 && (
                <Chip
                  label={`Package: ${filters.packageType.slice(0, 3).join(", ")}${filters.packageType.length > 3 ? "..." : ""}`}
                  onDelete={() => clearFilter("packageType")}
                  color="primary"
                  size="small"
                  deleteIcon={<X size={14} />}
                />
              )}
              {filters.riskFactors.length > 0 && (
                <Chip
                  label={`Risk: ${filters.riskFactors.slice(0, 3).join(", ")}${filters.riskFactors.length > 3 ? "..." : ""}`}
                  onDelete={() => clearFilter("riskFactors")}
                  color="primary"
                  size="small"
                  deleteIcon={<X size={14} />}
                />
              )}
              {filters.status.length > 0 && (
                <Chip
                  label={`Fix Status: ${filters.status.join(", ")}`}
                  onDelete={() => clearFilter("status")}
                  color="primary"
                  size="small"
                  deleteIcon={<X size={14} />}
                />
              )}
              {filters.dateRange.start && filters.dateRange.end && (
                <Chip
                  label={`Date: ${filters.dateRange.start} to ${filters.dateRange.end}`}
                  onDelete={() => clearFilter("dateRange")}
                  color="primary"
                  size="small"
                  deleteIcon={<X size={14} />}
                />
              )}
            </Box>
          </Box>
        </Box>
      )}

      {/* List Container */}
      <Box
        sx={{
          bgcolor: "background.paper",
          border: "1px solid",
          borderColor: "divider",
          borderRadius: 2,
          overflow: "hidden",
        }}
      >
        {/* List Header */}
        <Box
          sx={{
            display: "grid",
            gridTemplateColumns: "40px 110px 180px 2fr 90px 130px 100px",
            gap: 2,
            p: 2,
            bgcolor: "#252b3b",
            borderBottom: "1px solid",
            borderColor: "divider",
            fontSize: "0.8125rem",
            fontWeight: 600,
            color: "text.secondary",
            textTransform: "uppercase",
            letterSpacing: "0.05em",
          }}
        >
          <Box></Box>
          <Box
            sx={{ display: "flex", alignItems: "center", gap: 0.5, cursor: "pointer", userSelect: "none", "&:hover": { color: "text.primary" } }}
            onClick={() => handleSort("severity")}
          >
            Severity
            <ArrowUpDown size={14} style={{ opacity: 0.5 }} />
          </Box>
          <Box
            sx={{ display: "flex", alignItems: "center", gap: 0.5, cursor: "pointer", userSelect: "none", "&:hover": { color: "text.primary" } }}
            onClick={() => handleSort("cve")}
          >
            CVE
            <ArrowUpDown size={14} style={{ opacity: 0.5 }} />
          </Box>
          <Box
            sx={{ display: "flex", alignItems: "center", gap: 0.5, cursor: "pointer", userSelect: "none", "&:hover": { color: "text.primary" } }}
            onClick={() => handleSort("packageName")}
          >
            Package
            <ArrowUpDown size={14} style={{ opacity: 0.5 }} />
          </Box>
          <Box
            sx={{ display: "flex", alignItems: "center", gap: 0.5, cursor: "pointer", userSelect: "none", "&:hover": { color: "text.primary" } }}
            onClick={() => handleSort("cvss")}
          >
            CVSS
            <ArrowUpDown size={14} style={{ opacity: 0.5 }} />
          </Box>
          <Box
            sx={{ display: "flex", alignItems: "center", gap: 0.5, cursor: "pointer", userSelect: "none", "&:hover": { color: "text.primary" } }}
            onClick={() => handleSort("published")}
          >
            Published
            <ArrowUpDown size={14} style={{ opacity: 0.5 }} />
          </Box>
          <Box>Actions</Box>
        </Box>

        {/* Virtual List */}
        <Box
          ref={parentRef}
          sx={{ height: "600px", overflow: "auto", position: "relative" }}
        >
          {filteredVulnerabilities.length === 0 ? (
            <Box
              sx={{
                display: "flex",
                flexDirection: "column",
                alignItems: "center",
                justifyContent: "center",
                p: 6,
                textAlign: "center",
                minHeight: "400px",
              }}
            >
              <Filter
                size={48}
                style={{ color: "#5f6368", marginBottom: "24px", opacity: 0.5 }}
              />
              <Typography variant="h5" sx={{ fontWeight: 600, mb: 1 }}>
                No Results Found
              </Typography>
              <Typography variant="body1" color="text.secondary" sx={{ mb: 2 }}>
                No vulnerabilities match your current filters.
              </Typography>
              {hasActiveFilters && (
                <Button
                  variant="outlined"
                  onClick={() => setFilters(defaultFilters)}
                >
                  Clear All Filters
                </Button>
              )}
            </Box>
          ) : (
            <Box
              sx={{
                height: `${virtualizer.getTotalSize()}px`,
                width: "100%",
                position: "relative",
              }}
            >
              {virtualizer.getVirtualItems().map((virtualRow) => {
                const vuln = filteredVulnerabilities[virtualRow.index];
                const isSelected = selectedForComparison.has(vuln.id);

                return (
                  <Box
                    key={virtualRow.key}
                    sx={{
                      position: "absolute",
                      top: 0,
                      left: 0,
                      width: "100%",
                      transform: `translateY(${virtualRow.start}px)`,
                      display: "grid",
                      gridTemplateColumns: "40px 110px 180px 2fr 90px 130px 100px",
                      gap: 2,
                      p: 2,
                      borderBottom: "1px solid",
                      borderColor: "divider",
                      transition: "background 0.2s",
                      minHeight: "80px",
                      alignItems: "center",
                      "&:hover": {
                        bgcolor: "#252b3b",
                      },
                    }}
                  >
                    {/* Checkbox */}
                    <Box
                      sx={{
                        display: "flex",
                        alignItems: "center",
                        justifyContent: "center",
                      }}
                    >
                      <Checkbox
                        checked={isSelected}
                        onChange={() => toggleComparison(vuln.id)}
                        size="small"
                      />
                    </Box>

                    {/* Severity */}
                    <Box>
                      <Chip
                        label={vuln.severity}
                        size="small"
                        sx={{
                          bgcolor: getSeverityColor(vuln.severity),
                          color: "white",
                          fontWeight: 600,
                          fontSize: "0.75rem",
                          textTransform: "uppercase",
                        }}
                      />
                    </Box>

                    {/* CVE */}
                    <Box sx={{ display: "flex", flexDirection: "column", gap: 0.5 }}>
                      <Typography
                        sx={{
                          fontWeight: 600,
                          fontFamily: "'Monaco', 'Courier New', monospace",
                          fontSize: "0.875rem",
                        }}
                      >
                        {vuln.cve}
                      </Typography>
                      {vuln.kaiStatus && (
                        <Chip
                          label={vuln.kaiStatus}
                          size="small"
                          sx={{
                            fontSize: "0.6875rem",
                            height: "auto",
                            py: 0.25,
                            bgcolor: "rgba(6, 182, 212, 0.1)",
                            color: "secondary.main",
                            width: "fit-content",
                          }}
                        />
                      )}
                    </Box>

                    {/* Package */}
                    <Box
                      sx={{
                        display: "flex",
                        flexDirection: "column",
                        gap: 0.5,
                        overflow: "hidden",
                      }}
                    >
                      <Typography
                        sx={{
                          fontWeight: 500,
                          fontSize: "0.875rem",
                          whiteSpace: "nowrap",
                          overflow: "hidden",
                          textOverflow: "ellipsis",
                        }}
                      >
                        {vuln.packageName}
                      </Typography>
                      <Typography
                        variant="body2"
                        color="text.secondary"
                        sx={{
                          fontSize: "0.75rem",
                          fontFamily: "'Monaco', 'Courier New', monospace",
                        }}
                      >
                        v{vuln.packageVersion}
                      </Typography>
                    </Box>

                    {/* CVSS */}
                    <Box>
                      <Typography
                        sx={{
                          fontWeight: 700,
                          fontSize: "1rem",
                          color: "primary.main",
                          fontFeatureSettings: "'tnum'",
                        }}
                      >
                        {vuln.cvss}
                      </Typography>
                    </Box>

                    {/* Published */}
                    <Box>
                      <Typography
                        variant="body2"
                        color="text.secondary"
                        sx={{ fontSize: "0.875rem" }}
                      >
                        {new Date(vuln.published).toLocaleDateString()}
                      </Typography>
                    </Box>

                    {/* Actions */}
                    <Box sx={{ display: "flex", gap: 0.5, justifyContent: "flex-end" }}>
                      <IconButton
                        size="small"
                        onClick={() => navigate(`/vulnerabilities/${vuln.id}`)}
                      >
                        <ExternalLink size={16} />
                      </IconButton>
                    </Box>
                  </Box>
                );
              })}
            </Box>
          )}
        </Box>
      </Box>
    </Box>
  );
}

export default VulnerabilityList;
