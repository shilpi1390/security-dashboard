import { useState, useCallback, useRef, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import { useVirtualizer } from "@tanstack/react-virtual";
import { useVulnerability } from "../context/VulnerabilityContext";
import {
  Search,
  SlidersHorizontal,
  Download,
  ArrowUpDown,
  GitCompare,
  ExternalLink,
  Filter,
  X,
} from "lucide-react";
import AnalysisModeSelector from "../components/AnalysisModeSelector";
import FilterPanel from "../components/FilterPanel";
import LoadingSpinner from "../components/LoadingSpinner";
import { exportToJSON, exportToCSV } from "../utils/dataLoader";
import "./VulnerabilityList.css";

const defaultFilters = {
  severity: [],
  kaiStatus: [],
  packageType: [],
  riskFactors: [],
  searchQuery: "",
  status: [],
  dateRange: {
    start: null,
    end: null,
  },
};

function VulnerabilityList() {
  const navigate = useNavigate();
  const {
    filteredVulnerabilities,
    isLoading,
    filters,
    setFilters,
    setSorting,
    sortBy,
    sortOrder,
    selectedForComparison,
    toggleComparison,
  } = useVulnerability();

  const [showFilters, setShowFilters] = useState(false);
  const [searchQuery, setSearchQuery] = useState(filters.searchQuery);
  const [showExportMenu, setShowExportMenu] = useState(false);

  const parentRef = useRef<HTMLDivElement>(null);

  const virtualizer = useVirtualizer({
    count: filteredVulnerabilities.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 120,
    overscan: 10,
  });

  const handleSearch = useCallback(
    (value: string) => {
      setSearchQuery(value);
      setFilters({ ...filters, searchQuery: value });
    },
    [filters, setFilters],
  );

  const handleSort = (field: string) => {
    const newOrder = sortBy === field && sortOrder === "desc" ? "asc" : "desc";
    setSorting(field as any, newOrder);
  };

  const handleExport = (format: "json" | "csv") => {
    const timestamp = new Date().toISOString().split("T")[0];
    if (format === "json") {
      exportToJSON(
        filteredVulnerabilities,
        `vulnerabilities-${timestamp}.json`,
      );
    } else {
      exportToCSV(filteredVulnerabilities, `vulnerabilities-${timestamp}.csv`);
    }
    setShowExportMenu(false);
  };

  // Close export menu when clicking outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      const target = event.target as HTMLElement;
      if (!target.closest(".dropdown")) {
        setShowExportMenu(false);
      }
    };

    if (showExportMenu) {
      document.addEventListener("mousedown", handleClickOutside);
    }

    return () => {
      document.removeEventListener("mousedown", handleClickOutside);
    };
  }, [showExportMenu]);

  const clearFilter = (filterType: keyof typeof filters) => {
    if (
      filterType === "severity" ||
      filterType === "packageType" ||
      filterType === "riskFactors" ||
      filterType === "status"
    ) {
      setFilters({ ...filters, [filterType]: [] });
    } else if (filterType === "dateRange") {
      setFilters({ ...filters, dateRange: { start: null, end: null } });
    }
  };

  const hasActiveFilters =
    filters.severity.length > 0 ||
    filters.packageType.length > 0 ||
    filters.riskFactors.length > 0 ||
    filters.status.length > 0 ||
    (filters.dateRange.start !== null && filters.dateRange.end !== null);

  if (isLoading) {
    return <LoadingSpinner />;
  }

  return (
    <div className="vulnerability-list-page">
      <div className="page-header">
        <div>
          <h1>Vulnerabilities</h1>
          <p className="subtitle">
            {filteredVulnerabilities.length.toLocaleString()} vulnerabilities
            found
          </p>
        </div>
        <AnalysisModeSelector />
      </div>

      <div className="toolbar">
        <div className="search-bar">
          <Search size={20} />
          <input
            type="text"
            placeholder="Search CVE, package, description..."
            value={searchQuery}
            onChange={(e) => handleSearch(e.target.value)}
            className="search-input"
          />
        </div>

        <div className="toolbar-actions">
          <button
            className={`btn btn-secondary ${showFilters ? "active" : ""}`}
            onClick={() => setShowFilters(!showFilters)}
          >
            <SlidersHorizontal size={18} />
            Filters
          </button>

          <div className="dropdown">
            <button
              className="btn btn-secondary"
              onClick={() => setShowExportMenu(!showExportMenu)}
            >
              <Download size={18} />
              Export
            </button>
            {showExportMenu && (
              <div className="dropdown-menu">
                <button onClick={() => handleExport("json")}>
                  Export as JSON
                </button>
                <button onClick={() => handleExport("csv")}>
                  Export as CSV
                </button>
              </div>
            )}
          </div>

          {selectedForComparison.size > 0 && (
            <button
              className="btn btn-primary"
              onClick={() => navigate("/comparison")}
            >
              <GitCompare size={18} />
              Compare ({selectedForComparison.size})
            </button>
          )}
        </div>
      </div>

      {showFilters && <FilterPanel />}

      {hasActiveFilters && (
        <div className="active-filters-banner">
          <div className="active-filters-content">
            <Filter size={18} className="filter-icon" />
            <div className="active-filters-list">
              <span className="filter-label">Active Filters:</span>
              {filters.severity.length > 0 && (
                <div className="filter-tag">
                  <span>Severity: {filters.severity.join(", ")}</span>
                  <button
                    onClick={() => clearFilter("severity")}
                    className="clear-tag"
                  >
                    <X size={14} />
                  </button>
                </div>
              )}
              {filters.packageType.length > 0 && (
                <div className="filter-tag">
                  <span>
                    Package: {filters.packageType.slice(0, 3).join(", ")}
                    {filters.packageType.length > 3 ? "..." : ""}
                  </span>
                  <button
                    onClick={() => clearFilter("packageType")}
                    className="clear-tag"
                  >
                    <X size={14} />
                  </button>
                </div>
              )}
              {filters.riskFactors.length > 0 && (
                <div className="filter-tag">
                  <span>
                    Risk: {filters.riskFactors.slice(0, 3).join(", ")}
                    {filters.riskFactors.length > 3 ? "..." : ""}
                  </span>
                  <button
                    onClick={() => clearFilter("riskFactors")}
                    className="clear-tag"
                  >
                    <X size={14} />
                  </button>
                </div>
              )}
              {filters.status.length > 0 && (
                <div className="filter-tag">
                  <span>Fix Status: {filters.status.join(", ")}</span>
                  <button
                    onClick={() => clearFilter("status")}
                    className="clear-tag"
                  >
                    <X size={14} />
                  </button>
                </div>
              )}
              {filters.dateRange.start && filters.dateRange.end && (
                <div className="filter-tag">
                  <span>
                    Date: {filters.dateRange.start} to {filters.dateRange.end}
                  </span>
                  <button
                    onClick={() => clearFilter("dateRange")}
                    className="clear-tag"
                  >
                    <X size={14} />
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      <div className="list-container">
        <div className="list-header">
          <div className="col-checkbox"></div>
          <div className="col-severity" onClick={() => handleSort("severity")}>
            Severity
            <ArrowUpDown size={14} className="sort-icon" />
          </div>
          <div className="col-cve" onClick={() => handleSort("cve")}>
            CVE
            <ArrowUpDown size={14} className="sort-icon" />
          </div>
          <div
            className="col-package"
            onClick={() => handleSort("packageName")}
          >
            Package
            <ArrowUpDown size={14} className="sort-icon" />
          </div>
          <div className="col-cvss" onClick={() => handleSort("cvss")}>
            CVSS
            <ArrowUpDown size={14} className="sort-icon" />
          </div>
          <div
            className="col-published"
            onClick={() => handleSort("published")}
          >
            Published
            <ArrowUpDown size={14} className="sort-icon" />
          </div>
          <div className="col-actions">Actions</div>
        </div>

        <div
          ref={parentRef}
          className="virtual-list"
          style={{ height: "600px", overflow: "auto" }}
        >
          {filteredVulnerabilities.length === 0 ? (
            <div className="empty-state">
              <Filter size={48} className="empty-icon" />
              <h3>No Results Found</h3>
              <p>No vulnerabilities match your current filters.</p>
              {hasActiveFilters && (
                <button
                  className="btn btn-secondary"
                  onClick={() => setFilters(defaultFilters)}
                >
                  Clear All Filters
                </button>
              )}
            </div>
          ) : (
            <div
              style={{
                height: `${virtualizer.getTotalSize()}px`,
                width: "100%",
                position: "relative",
              }}
            >
              {virtualizer.getVirtualItems().map((virtualRow) => {
                const vuln = filteredVulnerabilities[virtualRow.index];
                const isSelected = selectedForComparison.has(vuln.id);

                return (
                  <div
                    key={virtualRow.key}
                    className="list-row"
                    style={{
                      position: "absolute",
                      top: 0,
                      left: 0,
                      width: "100%",
                      transform: `translateY(${virtualRow.start}px)`,
                    }}
                  >
                    <div className="col-checkbox">
                      <input
                        type="checkbox"
                        checked={isSelected}
                        onChange={() => toggleComparison(vuln.id)}
                        className="checkbox"
                      />
                    </div>
                    <div className="col-severity">
                      <span className={`badge badge-${vuln.severity}`}>
                        {vuln.severity}
                      </span>
                    </div>
                    <div className="col-cve">
                      <span className="cve-id">{vuln.cve}</span>
                      {vuln.kaiStatus && (
                        <span className="kai-status">{vuln.kaiStatus}</span>
                      )}
                    </div>
                    <div className="col-package">
                      <div className="package-name">{vuln.packageName}</div>
                      <div className="package-version">
                        v{vuln.packageVersion}
                      </div>
                    </div>
                    <div className="col-cvss">
                      <span className="cvss-score">{vuln.cvss}</span>
                    </div>
                    <div className="col-published">
                      {new Date(vuln.published).toLocaleDateString()}
                    </div>
                    <div className="col-actions">
                      <button
                        className="btn btn-ghost btn-sm"
                        onClick={() => navigate(`/vulnerabilities/${vuln.id}`)}
                      >
                        <ExternalLink size={16} />
                      </button>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

export default VulnerabilityList;
